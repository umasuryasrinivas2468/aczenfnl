<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cashfree Payment Integration Demo</title>
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f9f9f9;
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    .container {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 30px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    input {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
      width: 100%;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #45a049;
    }
    .error {
      color: #d32f2f;
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
      background-color: #ffebee;
      display: none;
    }
    .logo {
      text-align: center;
      margin-bottom: 20px;
    }
    .cashfree-badge {
      display: block;
      margin: 20px auto;
      text-align: center;
      color: #666;
      font-size: 14px;
    }
    .steps {
      margin-top: 30px;
    }
    .step {
      display: flex;
      margin-bottom: 15px;
    }
    .step-number {
      background-color: #4CAF50;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      flex-shrink: 0;
    }
    .step-content {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <h1>Cashfree Payment Demo</h1>
      <p>Test the Cashfree payment gateway integration</p>
    </div>
    
    <div class="form-group">
      <label for="amount">Amount (â‚¹)</label>
      <input type="number" id="amount" min="1" value="100">
    </div>
    
    <div class="form-group">
      <label for="name">Name</label>
      <input type="text" id="name" placeholder="John Doe">
    </div>
    
    <div class="form-group">
      <label for="phone">Phone Number</label>
      <input type="tel" id="phone" placeholder="9999999999">
    </div>
    
    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="john@example.com">
    </div>
    
    <button id="payButton">Pay Now</button>
    
    <div id="error" class="error"></div>
  </div>
  
  <div class="container steps">
    <h2>How It Works</h2>
    
    <div class="step">
      <div class="step-number">1</div>
      <div class="step-content">
        <h3>Enter Payment Details</h3>
        <p>Fill in the required information above including payment amount and your contact details.</p>
      </div>
    </div>
    
    <div class="step">
      <div class="step-number">2</div>
      <div class="step-content">
        <h3>Create Order</h3>
        <p>When you click "Pay Now", our server creates a payment order with Cashfree.</p>
      </div>
    </div>
    
    <div class="step">
      <div class="step-number">3</div>
      <div class="step-content">
        <h3>Complete Payment</h3>
        <p>You'll be redirected to the Cashfree checkout page to complete your payment using various methods.</p>
      </div>
    </div>
    
    <div class="step">
      <div class="step-number">4</div>
      <div class="step-content">
        <h3>Payment Confirmation</h3>
        <p>After payment is processed, you'll be redirected back to our confirmation page.</p>
      </div>
    </div>
  </div>
  
  <p class="cashfree-badge">Powered by Cashfree Payments</p>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Cashfree with proper async handling
      let cashfree;
      
      async function initializeCashfree() {
        cashfree = Cashfree({
          mode: "production",
        });
        console.log('Cashfree SDK initialized successfully');
      }
      
      // Initialize right away
      initializeCashfree();
      
      // Get elements
      const payButton = document.getElementById('payButton');
      const errorDiv = document.getElementById('error');
      
      // Function to get secure domain for callbacks
      function getSecureDomain() {
        // Get the current domain
        const currentDomain = window.location.hostname;
        
        // For localhost development, we'll use a placeholder secure domain
        if (currentDomain === 'localhost' || currentDomain === '127.0.0.1') {
          return 'https://aczenfnl.vercel.app/'; // Replace with your actual domain
        }
        
        // For production, ensure we're using HTTPS
        const protocol = 'https://';
        return protocol + currentDomain;
      }
      
      // Add click event to the button
      payButton.addEventListener('click', async function() {
        try {
          // Clear previous errors
          errorDiv.style.display = 'none';
          errorDiv.innerText = '';
          
          // Get form values
          const amount = document.getElementById('amount').value;
          const customerName = document.getElementById('name').value;
          const customerPhone = document.getElementById('phone').value;
          const customerEmail = document.getElementById('email').value;
          
          // Validate form
          if (!amount || !customerPhone) {
            showError('Amount and Phone Number are required');
            return;
          }
          
          // Disable button and show loading
          payButton.disabled = true;
          payButton.innerText = 'Processing...';
          
          // Get a secure domain for callbacks
          const frontendDomain = getSecureDomain();
          console.log('Using domain for callbacks:', frontendDomain);
          
          // Create order through your backend API
          const orderResponse = await fetch('/api/create-cashfree-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              orderAmount: parseFloat(amount),
              orderId: `order_${Date.now()}`,
              customerDetails: {
                customerId: `customer_${Date.now()}`,
                customerName: customerName || "Customer",
                customerEmail: customerEmail || "customer@example.com",
                customerPhone: customerPhone
              },
              orderMeta: {
                returnUrl: `${frontendDomain}/api/payments/payment-success?order_id={order_id}`
              }
            }),
          });
          
          const orderData = await orderResponse.json();
          
          if (!orderData.payment_session_id) {
            throw new Error(orderData.message || 'Failed to create order');
          }
          
          console.log('Order created successfully:', orderData);
          
          // Make sure cashfree is initialized
          if (!cashfree) {
            await initializeCashfree();
          }
          
          // Initialize the checkout with exactly the format from your example
          const checkoutOptions = {
            paymentSessionId: orderData.payment_session_id,
            redirectTarget: "_self",
          };
          
          console.log('Opening Cashfree checkout with options:', checkoutOptions);
          
          // Open Cashfree checkout exactly as in your example
          cashfree.checkout(checkoutOptions);
          
        } catch (error) {
          console.error('Payment error:', error);
          showError(error.message || 'Something went wrong');
          
          // Re-enable button
          payButton.disabled = false;
          payButton.innerText = 'Pay Now';
        }
      });
      
      // Helper function to show errors
      function showError(message) {
        errorDiv.innerText = message;
        errorDiv.style.display = 'block';
      }
    });
  </script>
</body>
</html> 